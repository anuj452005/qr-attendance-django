{% extends 'base/base.html' %}

{% block title %}Attendance QR Code — QR Attend{% endblock %}

{% block extra_css %}
<style>.countdown-ring { font-variant-numeric: tabular-nums; }</style>
{% endblock %}

{% block content %}

<div class="page-header">
  <h2><i class="fas fa-qrcode me-2" style="color:var(--primary);"></i>Attendance QR Code</h2>
  <p>Show this QR to your students — it will expire in 5 minutes</p>
</div>

<div class="row justify-content-center">
  <div class="col-md-7 col-lg-5">
    <div class="card mb-3">
      <div class="card-body" style="display:flex;align-items:center;gap:1rem;">
        <div class="action-icon icon-primary" style="flex-shrink:0;"><i class="fas fa-book"></i></div>
        <div>
          <div style="font-weight:700;font-size:1.05rem;">{{ timetable.subject.name }}</div>
          <div style="font-size:.85rem;color:var(--text-muted);">{{ timetable.day }} &bull; {{ timetable.start_time|time:"g:i A" }} - {{ timetable.end_time|time:"g:i A" }}</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body text-center" style="padding:2.5rem 2rem;">
        <div style="display:inline-block;margin-bottom:1.5rem;">
          <div class="qr-wrapper">
            <div class="qr-pulse"></div>
            <img src="data:image/png;base64,{{ qr_image }}" alt="Attendance QR Code" style="width:240px;height:240px;display:block;border-radius:4px;">
          </div>
        </div>
        <div class="expiry-pill mb-3">
          <i class="fas fa-hourglass-half"></i>
          <span class="countdown-ring" id="countdown">5:00</span> remaining
        </div>
        <p style="font-size:.8rem;color:var(--text-muted);">Expires at <strong>{{ qr_code.expires_at|time:"g:i A" }}</strong></p>
        <a href="{% url 'attendance:take_attendance' %}" class="btn btn-secondary mt-2">
          <i class="fas fa-rotate-right"></i> Generate New QR
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function() {
  const expiresAt = new Date("{{ qr_code.expires_at|date:'c' }}");
  const el = document.getElementById('countdown');
  function tick() {
    const diff = Math.max(0, Math.floor((expiresAt - Date.now()) / 1000));
    const m = String(Math.floor(diff / 60)).padStart(1,'0');
    const s = String(diff % 60).padStart(2,'0');
    el.textContent = m + ':' + s;
    if (diff <= 0) { el.closest('.expiry-pill').style.opacity='.5'; clearInterval(timer); }
  }
  tick();
  const timer = setInterval(tick, 1000);
})();
</script>
{% endblock %}
